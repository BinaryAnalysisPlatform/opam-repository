#!/bin/sh

# if LLVM_CONFIG variable doesn't explicitly specify which llvm-config
# we should use, then we will search across all possible llvm-configs
# that might work for us.  Our search strategy is to try to pick up
# 3.4, then 3.8, then 4.0.0, and, if neither found, fallback to any
# llvm-config.
#
# Note1 - suffix `-mp-` stands for macports, and will work on macs
# ifused with macports.
#
# Note2 - the LLVM_CONFIG variable is a fallback for debugging or
# workarounds. The recommended way to install a desired <version> of
# llvm is to use `llvm-conf.<version>` package.

config=${LLVM_CONFIG}

if ! which "$env_config" ; then
    config="llvm-config"
    versions="3.4 3.8 4.0"

    for version in $versions; do

        if hash brew 2>/dev/null; then
            brew_llvm_config="$(brew --cellar)"/llvm*/${version}*/bin/llvm-config
        fi

        configs="llvm-config-$version llvm-config${version//./} llvm-config-mp-$version $brew_llvm_config"

        for llvm_config in $configs; do
            llvm_version="`$llvm_config --version`" || true
            case $llvm_version in
                $version*)
                    echo "config: $llvm_config"
                    echo "version: $llvm_version"
                    config=$llvm_config ;;
                *)
                    echo "Note: '$llvm_config' doesn't match the required version. Got '$llvm_version' but required '$version'."
                    continue;
            esac
        done
    done
fi

if ! which "$config" ; then
    exit 1
else
    version=`$config --version`
fi

cat > conf-bap-llvm.config <<EOF
config: "$config"
version: "$version"
EOF
